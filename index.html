<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>🎮 موقع الألعاب - أيقونات الألعاب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@200;400;500;600;700;800;900&display=swap");
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: url("https://i.pinimg.com/originals/d7/b9/0c/d7b90cc80898e8823455a127945719af.jpg") no-repeat; background-size: cover; background-position: center; overflow-y: auto;}
    .wrapper { margin-top: 80px; width: 420px; background-color: transparent; border: 2px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); color: #fff; border-radius: 16px; padding: 20px 30px; direction: rtl; }
    .wrapper h1 { font-size: 30px; text-align: center; margin-bottom:20px;}
    .wrapper .input-box { width: 100%; height: 50px; position: relative; margin: 30px 0; }
    .input-box input { width: 100%; height: 100%; background: transparent; border: none; outline: none; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 40px; font-size: 16px; color: #fff; padding: 20px 45px 20px 20px; text-align: right; direction: rtl; }
    .input-box input::placeholder { color: #fff; text-align: right; }
    .input-box i { position: absolute; top: 50%; transform: translateY(-50%); font-size: 20px; left: 20px; }
    .wrapper .remember-forgot { display: flex; justify-content: space-between; font-size: 14px; margin: -15px 0 15px; direction: rtl; }
    .remember-forgot label input { accent-color: #fff; margin-left: 3px; }
    .remember-forgot a { color: #fff; text-decoration: none; }
    .remember-forgot a:hover { text-decoration: underline; }
    .wrapper .btn { width: 100%; height: 45px; background: #fff; border: none; outline: none; border-radius: 40px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); cursor: pointer; font-size: 16px; color: #333; font-weight: 600; margin-top: 15px; display: flex; align-items: center; justify-content: center;}
    .wrapper .btn:disabled { background: #aaa; color: #666; cursor: not-allowed; }
    .wrapper .register-link { text-align: center; font-size: 14px; margin: 20px 0 15px; }
    .wrapper .register-link p a { color: #fff; text-decoration: none; font-weight: 600; }
    .wrapper .register-link p a:hover { text-decoration: underline; }

    #auth-status { margin-top:10px; padding: 8px; border-radius: 8px; font-weight: 500; min-height: 1.5em; text-align: center; color: #fff; font-size: 0.9em;}
    #auth-status.success { background-color: rgba(40, 167, 69, 0.3); border: 1px solid rgba(40, 167, 69, 0.6); }
    #auth-status.error { background-color: rgba(220, 53, 69, 0.3); border: 1px solid rgba(220, 53, 69, 0.6); }
    #auth-status.info { background-color: rgba(23, 162, 184, 0.3); border: 1px solid rgba(23, 162, 184, 0.6); }
    
    nav { background:#002b4d; padding:12px; text-align:center; position:fixed; top:0; left:0; right:0; z-index: 1000; direction: rtl;}
    nav a { color:white; margin:0 10px; text-decoration:none; font-size:1.1rem; }
    nav a:hover, nav a.active-nav-link { text-decoration:underline; font-weight: bold; }
    
    section {
      display: none; /* sections are hidden by default */
      padding: 20px; 
      max-width: 600px;
      margin: 20px auto; 
      margin-top: 80px; 
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      direction: rtl;
    }
    section.active { display:block !important; } /* Ensure .active overrides display: none */

    section#login.active, section#game-launcher.active { 
        background: transparent; 
        box-shadow: none; 
        border: none; 
        padding: 0;
        max-width: none; 
    } 
     section#game-launcher.active {
        margin-top: 80px; 
        padding: 20px; 
     }
    
    section h2 {
      margin-top: 0; 
      color: #003B73;
      text-align: center;
      margin-bottom: 20px; 
    }
    section#game-launcher h2 {
        color: #fff; 
        font-size: 2rem;
        margin-bottom: 30px;
    }

    section:not(#login):not(#game-launcher) button { padding:10px 20px; margin:8px 4px; font-size:1rem; cursor:pointer; border:none; border-radius:8px; background:#005A9C; color:white; transition:background .2s; }
    section:not(#login):not(#game-launcher) button:hover { background:#003B73; }
    section:not(#login):not(#game-launcher) button:disabled { background:#ccc; cursor:not-allowed; }
    .status, .result, .message, .timebox { margin:15px 0; font-size:1.1rem; min-height: 1.2em; text-align: center;}
    
    .board { 
        display:grid; 
        grid-template-columns:repeat(3,100px); 
        gap:8px; 
        justify-content:center; 
        margin: 0 auto 20px auto; 
    }
    .cell { width:100px; height:100px; border:2px solid #aaa; display:flex; align-items:center; justify-content:center; font-size:2.8rem; background:#f9f9f9; transition:background .2s; cursor:pointer; border-radius: 8px;}
    .cell:hover { background:#e9e9e9; }

    .gamebox, 
    .cards {
      margin-top: 0; 
      margin-right: auto; 
      margin-bottom: 20px; 
      margin-left: auto; 
      text-align: center;
    }
    .cards {
        display: grid; 
        grid-template-columns: repeat(4, 1fr); 
        gap: 10px; 
        max-width: 380px; 
    }
    .card {
        width: 80px; height: 80px;
        background-color: #007bff; color: white;
        display: flex; align-items: center; justify-content: center;
        font-size: 2rem; border-radius: 8px; cursor: pointer;
        transition: transform 0.3s, background-color 0.3s;
        transform-style: preserve-3d; 
    }
    .card .card-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden; 
        display: flex; align-items: center; justify-content: center;
        border-radius: 8px;
    }
    .card .card-front { background-color: #005A9C; } 
    .card .card-back { background-color: #f0f0f0; color: #333; transform: rotateY(180deg); }
    .card.flipped { transform: rotateY(180deg); }
    .card.matched { background-color: #28a745 !important; cursor: default; }
    .card.matched .card-front { background-color: #28a745 !important; } 

    #click-target-area { 
        text-align: left; 
        min-height: 200px; 
        background-color: #e9ecef; 
        position: relative; 
        border-radius: 8px;
        overflow: hidden; 
    }
    #clickable-target {
        width: 50px; height: 50px;
        background-color: red;
        border-radius: 50%; 
        position: absolute;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem;
        transition: all 0.1s;
    }
    .timebox {
        padding: 20px;
        background-color: #6c757d; 
        color: white;
        border-radius: 8px;
        font-size: 1.5rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .timebox.waiting { background-color: #dc3545; } 
    .timebox.ready { background-color: #28a745; } 

    .text-to-type {
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 1.1rem;
        line-height: 1.6;
        background-color: #f8f9fa;
        direction: rtl; 
        text-align: right; 
    }
    #typing-input {
        width: 100%;
        padding: 10px;
        font-size: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        direction: rtl; 
        text-align: right; 
    }
    .input-group { text-align: center; } 
    .input-group input { margin: 0 auto 10px auto; display: block; max-width: 250px; text-align: center; padding:10px; border-radius: 8px; border:1px solid #ccc; }

    .hidden-by-auth { display: none !important; } /* Ensure this has high specificity */
    .button-text { margin: 0 5px; }

    .game-icons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
        gap: 25px;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto; 
    }
    .game-icon-card {
        background-color: rgba(0, 43, 77, 0.6); 
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.25s ease-out, box-shadow 0.25s ease-out, background-color 0.25s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 130px; 
        backdrop-filter: blur(5px);
    }
    .game-icon-card:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
        background-color: rgba(0, 60, 110, 0.7); 
    }
    .game-icon-card i {
        font-size: 3.5rem; 
        margin-bottom: 12px;
        color: #cce7ff; 
        transition: color 0.2s;
    }
     .game-icon-card:hover i {
        color: #fff;
     }
    .game-icon-card span {
        color: #fff;
        font-size: 1rem;
        font-weight: 500;
    }
  </style>
</head>
<body>

  <nav id="main-nav">
    <a href="#login" id="nav-login-link">تسجيل الدخول</a>
  </nav>

  <section id="login"> <!-- Initially, login might be active by default if no hash -->
    <div class="wrapper">
        <form action="javascript:void(0);">
            <h1 id="login-title">تسجيل الدخول</h1>
            <div id="auth-form-fields">
                <div class="input-box">
                    <input type="email" placeholder="البريد الإلكتروني" id="login-email" required>
                    <i class='bx bxs-user'></i>
                </div>
                <div class="input-box">
                    <input type="password" placeholder="كلمة المرور" id="login-password" required>
                    <i class='bx bxs-lock-alt'></i>
                </div>
            </div>
            <button type="button" class="btn" id="btn-main-action">
                 <span class="button-text">تسجيل الدخول</span>
            </button>
            <div class="register-link">
                <p id="toggle-auth-mode-text">ليس لديك حساب؟ <a href="#" id="toggle-auth-mode-link-inner">إنشاء حساب</a></p>
            </div>
            <button type="button" class="btn" id="btn-logout" style="display:none; margin-top: 10px;">تسجيل الخروج</button>
        </form>
        <div id="auth-status" class="info">يرجى تسجيل الدخول أو إنشاء حساب جديد.</div>
    </div>
  </section>

  <section id="game-launcher">
    <h2>اختر لعبتك المفضلة!</h2>
    <div class="game-icons-grid" id="game-icons-grid-container">
    </div>
  </section>


  <section id="xo" class="game-section"> <h2>إكس أو (XO)</h2> <div class="board"></div> <div class="status">الدور: ❌</div> <button id="xo-restart">إعادة XO</button> </section>
  <section id="rps" class="game-section"> <h2>حجر ورقة مقص 🧱📄✂️</h2> <div class="gamebox"> <button data-choice="🧱">🧱</button> <button data-choice="📄">📄</button> <button data-choice="✂️">✂️</button> </div> <div class="result">اختر لبدء!</div> </section>
  <section id="click" class="game-section"> <h2>اصطياد الهدف 🎯</h2> <div class="gamebox"><button id="click-start">ابدأ</button></div> <div id="click-target-area" class="gamebox" style="display:none;"></div> <div class="status">اضغط "ابدأ"</div> </section>
  <section id="react" class="game-section"> <h2>اختبار سرعة الضغط ⌛</h2> <div class="timebox" id="react-box">اضغط للبدء</div> </section>
  <section id="dice" class="game-section"> <h2>لعبة النرد 🎲</h2> <div class="gamebox"><button id="dice-roll">رمي النرد</button></div> <div class="result" id="dice-result" style="font-size: 3rem;">--</div> </section>
  <section id="memory" class="game-section"> <h2>لعبة الذاكرة 🧠</h2> <div class="cards"></div> <div class="status">اضغط بطاقة للبدء</div> <div class="gamebox"><button id="memory-restart">إعادة اللعبة</button></div> </section>
  <section id="math" class="game-section"> <h2>جمع الأرقام 🧮</h2> <div class="gamebox"><button id="math-start">ابدأ اللعبة</button></div> <div class="question-area" style="display:none; font-size: 1.5rem; margin-bottom: 15px; text-align:center;"></div> <div class="input-group" style="display:none;"> <input type="number" id="math-answer" placeholder="أدخل إجابتك"/> <button id="math-submit">تحقق</button> </div> <div class="result">--</div> </section>
  <section id="guessnum" class="game-section"> <h2>تخمين الرقم 🔢</h2> <div class="gamebox"><button id="guessnum-start">ابدأ اللعبة</button></div> <div class="input-group" style="display:none;"> <input type="number" id="guessnum-input" placeholder="خمن بين 1 و100"/> <button id="guessnum-submit">خمن</button> </div> <div class="result">--</div> <div class="message">خمن رقمًا بين 1 و 100</div> </section>
  <section id="bigsmall" class="game-section"> <h2>من الأكبر؟ 📏</h2> <div class="gamebox"><button id="bigsmall-start">ابدأ اللعبة</button></div> <div class="question-area" style="display:none; font-size: 1.5rem; margin-bottom: 15px; text-align:center;"></div> <div class="input-group" style="display:none;"> <input type="number" id="bigsmall-answer" placeholder="اكتب الرقم الأكبر"/> <button id="bigsmall-submit">تحقق</button> </div> <div class="result">--</div> </section>
  <section id="typing" class="game-section"> <h2>اختبار الكتابة ⌨️</h2> <div class="gamebox"><button id="typing-start">ابدأ الاختبار</button></div> <div class="text-to-type" style="display:none;"></div> <div class="input-group" style="display:none;"> <input type="text" id="typing-input" placeholder="اكتب النص هنا"/> <button id="typing-submit">تحقق</button> </div> <div class="status">--</div> </section>

  <audio id="snd-click" src="https://actions.google.com/sounds/v1/alarms/button_click.ogg"></audio>
  <audio id="snd-win" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="snd-lose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_cowbell.ogg"></audio>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLzpa2HYzJZdZvY_YuviKZ6Zg0FhWTfJw", 
        authDomain: "my-site-cdd00.firebaseapp.com",
        projectId: "my-site-cdd00",
        storageBucket: "my-site-cdd00.firebasestorage.app",
        messagingSenderId: "514123463555",
        appId: "1:514123463555:web:8499c5bde152537a3dd4b6",
        measurementId: "G-3Y7SYCE0NZ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', () => {
      // Helper functions (playSound, updateButtonText, etc.) remain the same
      const playSound = (id) => { const s = document.getElementById(id); if (s) { s.currentTime = 0; s.play().catch(e => console.warn(`Sound ${id} play failed:`, e)); } };
      const updateButtonText = (buttonElement, baseText) => { if (buttonElement) { const textSpan = buttonElement.querySelector('.button-text') || document.createElement('span'); textSpan.className = 'button-text'; textSpan.textContent = baseText; buttonElement.innerHTML = ''; buttonElement.appendChild(textSpan); }};
      const updateElementText = (el, txt, type) => { if(el) { el.textContent = txt; const baseClasses = el.className.split(' ').filter(c => !['info','success','error','waiting','ready'].includes(c)).join(' '); el.className = baseClasses; if (type) el.classList.add(type); }};
      const showHideElement = (el, show, disp = 'block') => { if(el) el.style.display = show ? disp : 'none'; };
      const disableElement = (el, dis) => { if(el) el.disabled = dis; };

      const allSections = document.querySelectorAll('section');
      const mainNav = document.getElementById('main-nav');
      const navLoginLink = document.getElementById('nav-login-link');
      const gameLauncherSection = document.getElementById('game-launcher');
      const gameIconsGridContainer = document.getElementById('game-icons-grid-container');
      
      const gameNavLinksData = [
          { id: "xo", text: "إكس أو", icon: "bxs-grid-alt" }, 
          { id: "rps", text: "حجر ورقة مقص", icon: "bxs-joystick-button" },
          { id: "click", text: "اصطياد الهدف", icon: "bxs-bullseye" }, 
          { id: "react", text: "سرعة الضغط", icon: "bxs-stopwatch" },
          { id: "dice", text: "النرد", icon: "bxs-dice-5" }, 
          { id: "memory", text: "الذاكرة", icon: "bxs-brain" },
          { id: "math", text: "الرياضيات", icon: "bxs-calculator" }, 
          { id: "guessnum", text: "تخمين الرقم", icon: "bxs-help-circle" },
          { id: "bigsmall", text: "من الأكبر", icon: "bxs-sort-alt" }, 
          { id: "typing", text: "الكتابة", icon: "bxs-keyboard" }
      ];
      let navGamesLink = null; 
      let isLoginMode = true;

      const loginTitle = document.getElementById('login-title');
      const mainActionButton = document.getElementById('btn-main-action');
      const toggleAuthModeText = document.getElementById('toggle-auth-mode-text');
      const authFormFields = document.getElementById('auth-form-fields');
      const loginEmailInput = document.getElementById('login-email');
      const loginPasswordInput = document.getElementById('login-password');
      const btnLogout = document.getElementById('btn-logout');
      const authStatusDiv = document.getElementById('auth-status');

      // --- AUTH LOGIC (updateAuthUI, updateLoginModeUI, toggleMode, handleAuthAction) ---
       const updateAuthUI = (isLoggedIn, userEmail = '', isVerified = true) => {
        showHideElement(authFormFields, !isLoggedIn);
        showHideElement(mainActionButton, !isLoggedIn);
        showHideElement(toggleAuthModeText.parentElement, !isLoggedIn);
        showHideElement(btnLogout, isLoggedIn);

        const currentActiveSection = document.querySelector('section.active');
        const activeSectionId = currentActiveSection ? currentActiveSection.id : 'login';

        if (isLoggedIn) {
          loginTitle.textContent = `أهلاً بك`;
          if (isVerified) {
            updateElementText(authStatusDiv, userEmail, 'success');
            // gameLauncherSection.classList.remove('hidden-by-auth'); // Will be handled by showSection
            if(gameIconsGridContainer && gameIconsGridContainer.children.length === 0) populateGameLauncher();
          } else {
            updateElementText(authStatusDiv, `تم تسجيل الدخول كـ ${userEmail}. يرجى التحقق من بريدك الإلكتروني للوصول الكامل.`, 'info');
            // gameLauncherSection.classList.add('hidden-by-auth'); // Will be handled by showSection
            if(gameIconsGridContainer) gameIconsGridContainer.innerHTML = ''; 
          }
          navLoginLink.textContent = 'تسجيل الخروج';
          navLoginLink.href = "#logout"; 
          navLoginLink.onclick = (e) => { e.preventDefault(); btnLogout.click(); };
          
        } else {
          isLoginMode = true; 
          updateLoginModeUI(); 
          updateElementText(authStatusDiv, 'يرجى تسجيل الدخول أو إنشاء حساب جديد.', 'info');
          navLoginLink.textContent = 'تسجيل الدخول';
          navLoginLink.href = "#login";
          navLoginLink.onclick = handleNavLinkClick;
          // gameLauncherSection.classList.add('hidden-by-auth'); // Will be handled by showSection
          if(gameIconsGridContainer) gameIconsGridContainer.innerHTML = ''; 
          allSections.forEach(s => { // Hide all sections except login if not logged in
                if(s.id !== 'login') s.classList.remove('active');
          });
        }
        updateNavigationDOM(isLoggedIn && isVerified, activeSectionId); 
      };

      const updateLoginModeUI = () => {
        const linkId = 'toggle-auth-mode-link-inner';
        if (isLoginMode) {
          loginTitle.textContent = 'تسجيل الدخول';
          updateButtonText(mainActionButton, 'تسجيل الدخول'); 
          toggleAuthModeText.innerHTML = `ليس لديك حساب؟ <a href="#" id="${linkId}">إنشاء حساب</a>`;
          loginPasswordInput.placeholder = "كلمة المرور";
        } else {
          loginTitle.textContent = 'إنشاء حساب جديد';
          updateButtonText(mainActionButton, 'إنشاء حساب'); 
          toggleAuthModeText.innerHTML = `لديك حساب بالفعل؟ <a href="#" id="${linkId}">تسجيل الدخول</a>`;
          loginPasswordInput.placeholder = "كلمة المرور (6+ حروف)";
        }
        const newToggleLink = document.getElementById(linkId);
        if(newToggleLink) newToggleLink.addEventListener('click', toggleMode);
      };
      
      const toggleMode = (e) => { 
        if(e) e.preventDefault(); 
        isLoginMode = !isLoginMode; 
        updateLoginModeUI(); 
        updateElementText(authStatusDiv, isLoginMode ? 'أدخل بيانات تسجيل الدخول.' : 'أدخل بيانات لإنشاء حساب جديد.', 'info'); 
      };

      const handleAuthAction = () => {
        const email = loginEmailInput.value.trim(); const password = loginPasswordInput.value;
        if (!email || !password) { updateElementText(authStatusDiv, "الرجاء إدخال البريد الإلكتروني وكلمة المرور.", 'error'); return; }
        if (!isLoginMode && password.length < 6) { updateElementText(authStatusDiv, "كلمة المرور يجب أن تكون 6 حروف على الأقل.", 'error'); return; }
        
        updateElementText(authStatusDiv, isLoginMode ? 'جاري تسجيل الدخول...' : 'جاري إنشاء الحساب...', 'info');
        disableElement(mainActionButton, true);

        if (isLoginMode) { 
            auth.signInWithEmailAndPassword(email, password)
              .then((userCredential) => {
                if (userCredential.user && !userCredential.user.emailVerified) {
                  updateElementText(authStatusDiv, "لقد سجلت الدخول، ولكن يجب التحقق من بريدك الإلكتروني أولاً.", 'error');
                  auth.signOut(); 
                } else {
                  loginEmailInput.value = ''; loginPasswordInput.value = '';
                  // onAuthStateChanged will handle UI update and navigation
                }
              })
              .catch((error) => {
                let msg = "حدث خطأ. حاول مرة أخرى.";
                if (error.code === 'auth/invalid-api-key' || (error.code === 'auth/internal-error' && error.message.includes("API key not valid"))) {
                    msg = "خطأ في تهيئة خدمة المصادقة. تأكد من صحة مفتاح API في الكود.";
                } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') msg = "البريد الإلكتروني أو كلمة المرور غير صحيحة.";
                else if (error.code === 'auth/invalid-email') msg = "صيغة البريد الإلكتروني غير صحيحة.";
                console.error("Auth Error Code:",error.code, "Message:", error.message); updateElementText(authStatusDiv, msg, 'error');
              })
              .finally(() => { disableElement(mainActionButton, false); });
        } else { 
            auth.createUserWithEmailAndPassword(email, password)
              .then((userCredential) => {
                if (userCredential.user) {
                  userCredential.user.sendEmailVerification()
                    .then(() => {
                      updateElementText(authStatusDiv, 'تم إنشاء الحساب بنجاح! تم إرسال رسالة تحقق إلى بريدك الإلكتروني. يرجى التحقق منها ثم تسجيل الدخول.', 'success');
                      auth.signOut(); 
                    })
                    .catch((error) => {
                      console.error("Error sending verification email:", error);
                      updateElementText(authStatusDiv, 'تم إنشاء الحساب، ولكن فشل إرسال بريد التحقق. حاول تسجيل الدخول لاحقًا.', 'error');
                       auth.signOut(); 
                    });
                }
                loginEmailInput.value = ''; loginPasswordInput.value = '';
              })
              .catch((error) => {
                let msg = "حدث خطأ. حاول مرة أخرى.";
                if (error.code === 'auth/invalid-api-key' || (error.code === 'auth/internal-error' && error.message.includes("API key not valid"))) {
                    msg = "خطأ في تهيئة خدمة المصادقة. تأكد من صحة مفتاح API في الكود.";
                } else if (error.code === 'auth/email-already-in-use') msg = "هذا البريد الإلكتروني مستخدم بالفعل.";
                else if (error.code === 'auth/weak-password') msg = "كلمة المرور ضعيفة (6 حروف على الأقل).";
                else if (error.code === 'auth/invalid-email') msg = "صيغة البريد الإلكتروني غير صحيحة.";
                console.error("Auth Error Code:",error.code, "Message:", error.message); updateElementText(authStatusDiv, msg, 'error');
              })
              .finally(() => { disableElement(mainActionButton, false); });
        }
      };
      // --- END AUTH LOGIC ---

      updateLoginModeUI(); 
      mainActionButton.addEventListener('click', handleAuthAction);
      btnLogout.addEventListener('click', () => { 
        auth.signOut().catch(e => console.error('Logout error', e)); 
        updateElementText(authStatusDiv, 'يرجى تسجيل الدخول أو إنشاء حساب جديد.', 'info');
        window.location.hash = 'login'; // Go to login on logout
      });

      // --- NAVIGATION AND SECTION DISPLAY ---
      const populateGameLauncher = () => {
        if (!gameIconsGridContainer) return;
        gameIconsGridContainer.innerHTML = ''; 
        gameNavLinksData.forEach(game => {
            const card = document.createElement('div');
            card.className = 'game-icon-card';
            card.dataset.targetId = game.id;
            
            const icon = document.createElement('i');
            icon.className = `bx ${game.icon}`;
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = game.text;
            
            card.appendChild(icon);
            card.appendChild(nameSpan);
            
            card.addEventListener('click', (e) => {
                const targetId = e.currentTarget.dataset.targetId;
                const currentUser = auth.currentUser;
                if (currentUser && currentUser.emailVerified) {
                    playSound('snd-click');
                    window.location.hash = targetId; // Change hash to navigate
                } else {
                    updateElementText(authStatusDiv, "يجب تسجيل الدخول والتحقق من بريدك الإلكتروني أولاً للعب.", "error");
                    window.location.hash = 'login';
                }
            });
            gameIconsGridContainer.appendChild(card);
        });
      };

      const updateNavigationDOM = (isLoggedInAndVerified, activeSectionId) => { 
        if (navGamesLink && navGamesLink.parentNode === mainNav) {
            mainNav.removeChild(navGamesLink);
            navGamesLink = null;
        }

        if (isLoggedInAndVerified) {
            const isGameSectionActive = gameNavLinksData.some(game => game.id === activeSectionId);
            if (isGameSectionActive) { 
                navGamesLink = document.createElement('a');
                navGamesLink.href = "#game-launcher";
                navGamesLink.textContent = "الألعاب";
                navGamesLink.id = "nav-games-launcher-link";
                navGamesLink.onclick = handleNavLinkClick; // Use onclick for nav links to avoid hash change conflicts initially
                mainNav.appendChild(navGamesLink);
            }
        }
        if (!mainNav.contains(navLoginLink)) {
            mainNav.insertBefore(navLoginLink, mainNav.firstChild);
        }
        Array.from(mainNav.children).forEach(a => {
            if (a) a.classList.remove('active-nav-link');
            if (a && a.getAttribute('href') === `#${activeSectionId}`) {
                a.classList.add('active-nav-link');
            }
        });
         if (activeSectionId === 'login' || (auth.currentUser && activeSectionId !== 'login' && !auth.currentUser.emailVerified) ) {
            if(navLoginLink) navLoginLink.classList.add('active-nav-link');
        } else if (navLoginLink) {
             navLoginLink.classList.remove('active-nav-link');
        }
      };

      const showSectionByHash = () => {
        const hash = window.location.hash.slice(1) || 'login'; // Default to login if no hash
        console.log("Attempting to show section for hash:", hash);

        const currentUser = auth.currentUser;
        const isVerified = currentUser && currentUser.emailVerified;
        let targetIdToShow = 'login'; // Default

        if (isVerified) {
            if (hash === 'game-launcher' || gameNavLinksData.some(game => game.id === hash)) {
                targetIdToShow = hash;
            } else if (hash === 'login'){ // If hash is login but user is verified, go to launcher
                 targetIdToShow = 'game-launcher';
                 window.location.hash = 'game-launcher'; // Correct the hash
            }
             else { // If hash is invalid for a verified user, go to launcher
                targetIdToShow = 'game-launcher';
                window.location.hash = 'game-launcher'; // Correct the hash
            }
        } else { // Not verified or not logged in
            if (hash !== 'login') {
                 window.location.hash = 'login'; // Force login hash
                 targetIdToShow = 'login'; // and show login
            } else {
                targetIdToShow = 'login';
            }
        }
        
        console.log("Final targetIdToShow:", targetIdToShow);
        allSections.forEach(s => {
            if (s.id === targetIdToShow) {
                s.classList.add('active');
                 console.log(`Section ${s.id} activated.`);
            } else {
                s.classList.remove('active');
            }
        });
        updateNavigationDOM(isVerified, targetIdToShow);
      };
      
      auth.onAuthStateChanged(user => {
        updateAuthUI(user, user ? user.email : '', user ? user.emailVerified : false);
        showSectionByHash(); // Update view based on auth state and current hash
      });


      const handleNavLinkClick = (e) => {
          e.preventDefault(); 
          const targetHash = e.currentTarget.getAttribute('href'); // #login, #logout, #game-launcher
          
          if (targetHash === '#logout') { 
             btnLogout.click();
             return;
           }
          window.location.hash = targetHash; // This will trigger hashchange
      };
      navLoginLink.addEventListener('click', handleNavLinkClick); // For "Login" / "Logout"
      
      window.addEventListener('hashchange', showSectionByHash);

      // --- Game Initializations (All game init functions are defined below) ---
      // (The game init functions themselves remain largely the same, ensuring they check auth status before allowing interaction)
      const initXOGame=()=>{const s=document.querySelector('#xo');if(!s)return;const bE=s.querySelector('.board'),sE=s.querySelector('.status'),rB=s.querySelector('#xo-restart');let b=Array(9).fill(''),cP='❌',gA=true;const wP=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];const cW=()=>{for(const p of wP){const [x,y,z]=p;if(b[x]&&b[x]===b[y]&&b[x]===b[z])return b[x];}return null;};const hC=(idx)=>{if(!auth.currentUser||!auth.currentUser.emailVerified){updateElementText(sE,'يرجى التحقق من بريدك للعب.','info');return;}if(!gA||b[idx])return;b[idx]=cP;bE.children[idx].textContent=cP;const w=cW();if(w){updateElementText(sE,`فاز ${w}`);playSound('snd-win');gA=false;}else if(!b.includes('')){updateElementText(sE,'تعادل');playSound('snd-lose');gA=false;}else{cP=cP==='❌'?'⭕':'❌';updateElementText(sE,`الدور: ${cP}`);playSound('snd-click');}};const rG=()=>{if(!auth.currentUser||!auth.currentUser.emailVerified){updateElementText(sE,'يرجى التحقق من بريدك للعب.','info');return;}b.fill('');cP='❌';gA=true;updateElementText(sE,'الدور: ❌');Array.from(bE.children).forEach(c=>c.textContent='');playSound('snd-click');};if(bE){bE.innerHTML=Array(9).fill().map((_,i)=>`<div class="cell" data-index="${i}"></div>`).join('');Array.from(bE.children).forEach((c,i)=>c.addEventListener('click',()=>hC(i)));}if(rB)rB.addEventListener('click',rG);if(sE)updateElementText(sE,'الدور: ❌');};
      
      const initRPSGame = () => { 
        const section = document.querySelector('#rps'); if(!section) return;
        const resultElement = section.querySelector('.result');
        const choiceButtons = section.querySelectorAll('.gamebox button');
        const options = ['🧱', '📄', '✂️']; 
        if(resultElement) updateElementText(resultElement, 'اختر لبدء!');
        choiceButtons.forEach(button => button.addEventListener('click', () => {
          if(!auth.currentUser||!auth.currentUser.emailVerified) {updateElementText(resultElement, 'يرجى التحقق من بريدك للعب.','info'); return;}
          const playerChoice = button.dataset.choice;
          const computerChoice = options[Math.floor(Math.random() * options.length)];
          let message = 'تعادل';
          if ( (playerChoice === '🧱' && computerChoice === '✂️') || (playerChoice === '📄' && computerChoice === '🧱') || (playerChoice === '✂️' && computerChoice === '📄') ) { message = 'فزت'; }
          else if (playerChoice !== computerChoice) { message = 'خسرت'; }
          updateElementText(resultElement, `${message}! أنت: ${playerChoice} الكومبيوتر: ${computerChoice}`);
          playSound(message === 'فزت' ? 'snd-win' : message === 'خسرت' ? 'snd-lose' : 'snd-click');
        }));
      };

      const initClickTargetGame = () => {
        const section = document.querySelector('#click'); if (!section) return;
        const startButton = section.querySelector('#click-start');
        const targetArea = section.querySelector('#click-target-area');
        const statusElement = section.querySelector('.status');
        let score = 0; let gameTimerId; let targetElement;
        const gameDuration = 15000; 

        const spawnTarget = () => {
            if(!targetArea) return; 
            if (targetElement) targetElement.remove();
            targetElement = document.createElement('div');
            targetElement.id = 'clickable-target';
            targetElement.textContent = '🎯';
            const areaRect = targetArea.getBoundingClientRect();
            const targetSize = 50;
             if (areaRect.height <= targetSize || areaRect.width <= targetSize) { 
                // console.warn("Target area too small or not visible for spawnTarget.");
                return; 
            }
            targetElement.style.top = Math.random() * (areaRect.height - targetSize) + 'px';
            targetElement.style.left = Math.random() * (areaRect.width - targetSize) + 'px';
            targetElement.onclick = () => {
                if(!auth.currentUser||!auth.currentUser.emailVerified) {updateElementText(statusElement, 'يرجى التحقق من بريدك للعب.','info'); return;}
                score++;
                updateElementText(statusElement, `النقاط: ${score}`);
                playSound('snd-click');
                spawnTarget();
            };
            targetArea.appendChild(targetElement);
        };

        const startGame = () => {
            if (!auth.currentUser||!auth.currentUser.emailVerified) {updateElementText(statusElement, 'يرجى التحقق من بريدك للعب.','info'); return;}
            score = 0;
            updateElementText(statusElement, 'النقاط: 0');
            showHideElement(startButton, false);
            showHideElement(targetArea, true);
            disableElement(startButton, true);
            setTimeout(spawnTarget, 50);

            clearTimeout(gameTimerId);
            gameTimerId = setTimeout(() => {
                if (targetElement) targetElement.remove();
                updateElementText(statusElement, `انتهت اللعبة! نقاطك: ${score}`);
                playSound(score > 5 ? 'snd-win' : 'snd-lose');
                showHideElement(startButton, true);
                showHideElement(targetArea, false);
                disableElement(startButton, false);
            }, gameDuration);
        };
        if(startButton) startButton.addEventListener('click', startGame);
        if(statusElement) updateElementText(statusElement, 'اضغط "ابدأ"');
      };

      const initReactionTestGame = () => {
        const section = document.querySelector('#react'); if (!section) return;
        const reactBox = section.querySelector('#react-box');
        let startTime, timeoutId, waitingForClick = false;

        const startGame = () => {
            if(!reactBox) return;
            if (!auth.currentUser||!auth.currentUser.emailVerified) {updateElementText(reactBox, 'يرجى التحقق من بريدك للعب.','info'); reactBox.classList.remove('waiting', 'ready'); return;}
            if (waitingForClick) { 
                if (reactBox.classList.contains('ready')) { 
                    const reactionTime = Date.now() - startTime;
                    updateElementText(reactBox, `وقتك: ${reactionTime} مللي ثانية`);
                    playSound('snd-win');
                } else { 
                    updateElementText(reactBox, 'مبكر جداً! اضغط للبدء من جديد.');
                    playSound('snd-lose');
                }
                waitingForClick = false;
                clearTimeout(timeoutId);
                reactBox.classList.remove('waiting', 'ready');
                updateElementText(reactBox, 'اضغط للبدء'); 
                return;
            }
            
            updateElementText(reactBox, 'انتظر اللون الأخضر...', 'waiting');
            waitingForClick = true;
            const randomDelay = Math.random() * 3000 + 1000; 

            timeoutId = setTimeout(() => {
                if (waitingForClick) { 
                    updateElementText(reactBox, 'اضغط الآن!', 'ready');
                    startTime = Date.now();
                }
            }, randomDelay);
        };
        if(reactBox) {
            reactBox.addEventListener('click', startGame);
            updateElementText(reactBox, 'اضغط للبدء'); 
        }
      };

      const initDiceRollGame = () => {
        const section = document.querySelector('#dice'); if (!section) return;
        const rollButton = section.querySelector('#dice-roll');
        const resultElement = section.querySelector('#dice-result');
        const diceFaces = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];

        if(rollButton) rollButton.addEventListener('click', () => {
            if (!auth.currentUser||!auth.currentUser.emailVerified) {updateElementText(resultElement, '--'); if(resultElement) resultElement.textContent = 'يرجى التحقق من بريدك.'; return;}
            const roll = Math.floor(Math.random() * 6);
            updateElementText(resultElement, diceFaces[roll]);
            playSound('snd-click');
        });
        if(resultElement) updateElementText(resultElement, '--');
      };

      const initMemoryGame = () => {
        const section = document.querySelector('#memory'); if (!section) return;
        const cardsContainer = section.querySelector('.cards');
        const statusElement = section.querySelector('.status');
        const restartButton = section.querySelector('#memory-restart');

        const cardValues = ['🧠', '🎮', '🎯', '🎲', '💡', '💻', '🌟', '🚀'];
        let gameCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let canFlip = true;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function createBoard() {
            if(!cardsContainer || !statusElement) return;
            if (auth.currentUser && !auth.currentUser.emailVerified) { 
                updateElementText(statusElement, 'يرجى التحقق من بريدك للعب.', 'info');
                cardsContainer.innerHTML = '';
                return;
            }

            cardsContainer.innerHTML = '';
            matchedPairs = 0;
            updateElementText(statusElement, 'جد الأزواج المتطابقة.');
            let items = shuffle([...cardValues, ...cardValues]); 
            gameCards = [];
            canFlip = true; 

            items.forEach(value => {
                const card = document.createElement('div');
                card.classList.add('card');
                card.dataset.value = value;
                const cardFaceFront = document.createElement('div');
                cardFaceFront.classList.add('card-face', 'card-front');
                const cardFaceBack = document.createElement('div');
                cardFaceBack.classList.add('card-face', 'card-back');
                cardFaceBack.textContent = value;
                card.appendChild(cardFaceFront);
                card.appendChild(cardFaceBack);
                card.addEventListener('click', () => flipCard(card));
                cardsContainer.appendChild(card);
                gameCards.push(card);
            });
        }
        
         function flipCard(card) {
            if (!auth.currentUser || !auth.currentUser.emailVerified) {
                if(statusElement) updateElementText(statusElement, 'يرجى التحقق من بريدك للعب.', 'info');
                return;
            }
            if (!canFlip || card.classList.contains('flipped') || card.classList.contains('matched')) return;
            
            card.classList.add('flipped');
            flippedCards.push(card);
            playSound('snd-click');

            if (flippedCards.length === 2) {
                canFlip = false; 
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            const isMatch = card1.dataset.value === card2.dataset.value;

            if (isMatch) {
                card1.classList.add('matched');
                card2.classList.add('matched');
                matchedPairs++;
                playSound('snd-win');
                if(statusElement) updateElementText(statusElement, `أزواج متطابقة: ${matchedPairs}/${cardValues.length}`);
                if (matchedPairs === cardValues.length) {
                    if(statusElement) updateElementText(statusElement, 'أحسنت! لقد وجدت كل الأزواج!', 'success');
                }
            } else {
                playSound('snd-lose');
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                }, 1000);
            }
            flippedCards = [];
            setTimeout(() => { canFlip = true; }, isMatch ? 200 : 1000); 
        }

        if(restartButton) restartButton.addEventListener('click', () => {
            if (!auth.currentUser||!auth.currentUser.emailVerified) {
                if(statusElement) updateElementText(statusElement, 'يرجى التحقق من بريدك للعب.', 'info');
                return;
            }
            createBoard();
            playSound('snd-click');
        });
        const observer = new MutationObserver((mutationsList, obs) => {
            for(const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (section.classList.contains('active') && auth.currentUser && auth.currentUser.emailVerified) {
                        if (cardsContainer.children.length === 0 || matchedPairs === cardValues.length) { 
                           createBoard();
                        }
                    } else if (!section.classList.contains('active')) {
                        // Optionally clear the board or reset game state when section becomes inactive
                        // cardsContainer.innerHTML = '';
                        // matchedPairs = 0;
                    }
                }
            }
        });
        if(section) observer.observe(section, { attributes: true });
      };
      
      const initMathQuizGame = () => {
        const section = document.querySelector('#math'); if (!section) return;
        const startButton = section.querySelector('#math-start');
        const questionArea = section.querySelector('.question-area');
        const answerInput = section.querySelector('#math-answer');
        const submitButton = section.querySelector('#math-submit');
        const resultElement = section.querySelector('.result');
        let correctAnswer;

        const generateQuestion = () => {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            correctAnswer = num1 + num2;
            if(questionArea) questionArea.textContent = `${num1} + ${num2} = ?`;
            if(answerInput) answerInput.value = '';
            if(resultElement) updateElementText(resultElement, '--');
        };
        const startGame = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified) {
                if(resultElement) updateElementText(resultElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            showHideElement(startButton, false);
            showHideElement(questionArea, true);
            showHideElement(section.querySelector('.input-group'), true, 'block'); 
            generateQuestion();
            if(answerInput) answerInput.focus();
            playSound('snd-click');
        };
        const checkAnswer = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified || !answerInput || !resultElement) {
                 if(resultElement) updateElementText(resultElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            const userAnswer = parseInt(answerInput.value);
            if (isNaN(userAnswer)) {
                updateElementText(resultElement, 'الرجاء إدخال رقم صحيح.', 'error');
                return;
            }
            if (userAnswer === correctAnswer) {
                updateElementText(resultElement, 'صحيح! 🎉', 'success');
                playSound('snd-win');
                setTimeout(() => { 
                    if (section.classList.contains('active') && auth.currentUser && auth.currentUser.emailVerified) generateQuestion(); 
                }, 1500);
            } else {
                updateElementText(resultElement, `خطأ. الإجابة الصحيحة: ${correctAnswer}`, 'error');
                playSound('snd-lose');
            }
             if(answerInput) {answerInput.value = ''; answerInput.focus(); }
        };

        if(startButton) startButton.addEventListener('click', startGame);
        if(submitButton) submitButton.addEventListener('click', checkAnswer);
        if(answerInput) answerInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
        if(resultElement) updateElementText(resultElement, '--');
      };

      const initGuessNumberGame = () => {
        const section = document.querySelector('#guessnum'); if (!section) return;
        const startButton = section.querySelector('#guessnum-start');
        const inputField = section.querySelector('#guessnum-input');
        const submitButton = section.querySelector('#guessnum-submit');
        const resultElement = section.querySelector('.result');
        const messageElement = section.querySelector('.message');
        let secretNumber, attempts;
        const maxAttempts = 7;

        const startGame = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified) {
                if(resultElement) updateElementText(resultElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            secretNumber = Math.floor(Math.random() * 100) + 1;
            attempts = 0;
            showHideElement(startButton, false);
            showHideElement(section.querySelector('.input-group'), true, 'block');
            if(inputField) inputField.value = '';
            if(messageElement) updateElementText(messageElement, `خمن رقمًا بين 1 و 100. لديك ${maxAttempts} محاولات.`);
            if(resultElement) updateElementText(resultElement, '--');
            if(inputField) inputField.focus();
            disableElement(submitButton, false);
            disableElement(inputField, false);
            playSound('snd-click');
        };
        const checkGuess = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified || !inputField || !resultElement || !messageElement) {
                if(resultElement) updateElementText(resultElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            const guess = parseInt(inputField.value);
            if (isNaN(guess) || guess < 1 || guess > 100) {
                updateElementText(resultElement, 'الرجاء إدخال رقم بين 1 و 100.', 'error');
                return;
            }
            attempts++;
            if (guess === secretNumber) {
                updateElementText(resultElement, `أحسنت! لقد خمنت الرقم ${secretNumber} في ${attempts} محاولات.`, 'success');
                playSound('snd-win');
                if(messageElement) updateElementText(messageElement, 'اضغط "ابدأ اللعبة" للعب مرة أخرى.');
                showHideElement(startButton, true);
                disableElement(submitButton, true);
                disableElement(inputField, true);
            } else {
                playSound('snd-click');
                const remainingAttempts = maxAttempts - attempts;
                if (remainingAttempts <= 0) {
                    updateElementText(resultElement, `للأسف انتهت محاولاتك. الرقم الصحيح كان ${secretNumber}.`, 'error');
                    playSound('snd-lose');
                    if(messageElement) updateElementText(messageElement, 'اضغط "ابدأ اللعبة" للعب مرة أخرى.');
                    showHideElement(startButton, true);
                    disableElement(submitButton, true);
                    disableElement(inputField, true);
                } else {
                    updateElementText(resultElement, guess < secretNumber ? 'أعلى!' : 'أقل!', 'info');
                    if(messageElement) updateElementText(messageElement, `محاولات متبقية: ${remainingAttempts}`);
                }
            }
            if(inputField) {
                 inputField.value = '';
                 inputField.focus();
            }
        };
        if(startButton) startButton.addEventListener('click', startGame);
        if(submitButton) submitButton.addEventListener('click', checkGuess);
        if(inputField) inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkGuess(); });
        if(messageElement) updateElementText(messageElement, 'خمن رقمًا بين 1 و 100');
      };

      const initBigSmallGame = () => {
        const section = document.querySelector('#bigsmall'); if (!section) return;
        const startButton = section.querySelector('#bigsmall-start');
        const questionArea = section.querySelector('.question-area');
        const answerInput = section.querySelector('#bigsmall-answer');
        const submitButton = section.querySelector('#bigsmall-submit');
        const resultElement = section.querySelector('.result');
        let num1, num2, biggerNum;

        const generateNumbers = () => {
            num1 = Math.floor(Math.random() * 100) + 1;
            do {
                num2 = Math.floor(Math.random() * 100) + 1;
            } while (num1 === num2); 
            biggerNum = Math.max(num1, num2);
            if(questionArea) questionArea.textContent = `أي الرقمين أكبر: ${num1} أم ${num2}؟`;
            if(answerInput) answerInput.value = '';
            if(resultElement) updateElementText(resultElement, '--');
        };
        const startGame = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified) {
                if(resultElement) updateElementText(resultElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            showHideElement(startButton, false);
            showHideElement(questionArea, true);
            showHideElement(section.querySelector('.input-group'), true, 'block');
            generateNumbers();
            if(answerInput) answerInput.focus();
            playSound('snd-click');
        };
        const checkAnswer = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified || !answerInput || !resultElement) {
                if(resultElement) updateElementText(resultElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            const userAnswer = parseInt(answerInput.value);
            if (isNaN(userAnswer)) {
                updateElementText(resultElement, 'الرجاء إدخال رقم.', 'error');
                return;
            }
            if (userAnswer === biggerNum) {
                updateElementText(resultElement, 'صحيح! 🎉', 'success');
                playSound('snd-win');
                 setTimeout(() => { 
                    if (section.classList.contains('active') && auth.currentUser && auth.currentUser.emailVerified) generateNumbers();
                }, 1500);
            } else {
                updateElementText(resultElement, `خطأ. الرقم الأكبر كان ${biggerNum}.`, 'error');
                playSound('snd-lose');
            }
            if(answerInput) {answerInput.value = ''; answerInput.focus();}
        };
        if(startButton) startButton.addEventListener('click', startGame);
        if(submitButton) submitButton.addEventListener('click', checkAnswer);
        if(answerInput) answerInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkAnswer(); });
        if(resultElement) updateElementText(resultElement, '--');
      };

      const initTypingTestGame = () => {
        const section = document.querySelector('#typing'); if (!section) return;
        const startButton = section.querySelector('#typing-start');
        const textToTypeElement = section.querySelector('.text-to-type');
        const inputField = section.querySelector('#typing-input');
        const submitButton = section.querySelector('#typing-submit'); 
        const statusElement = section.querySelector('.status');

        const sampleTexts = [
            "أهلاً بك في اختبار الكتابة السريع. حاول أن تكتب هذه الجملة بدقة وسرعة.",
            "ممارسة الكتابة بانتظام تحسن من مهارتك بشكل ملحوظ.",
            "الألعاب الإلكترونية وسيلة رائعة للترفيه وتنمية بعض المهارات الذهنية.",
            "البرمجة هي لغة المستقبل، وتعلمها يفتح آفاقاً واسعة.",
            "الذكاء الاصطناعي يتطور بسرعة ويغير حياتنا اليومية."
        ];
        let currentTextToType = "";
        let startTime;

        const startGame = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified) {
                if(statusElement) updateElementText(statusElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            currentTextToType = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
            if(textToTypeElement) textToTypeElement.textContent = currentTextToType;
            if(inputField) inputField.value = '';
            showHideElement(startButton, false);
            showHideElement(textToTypeElement, true);
            showHideElement(section.querySelector('.input-group'), true, 'block'); 
            showHideElement(submitButton, true); 
            disableElement(inputField, false);
            disableElement(submitButton, false);
            if(statusElement) updateElementText(statusElement, 'ابدأ الكتابة...');
            if(inputField) inputField.focus();
            startTime = new Date();
            playSound('snd-click');
        };
        const checkTyping = () => {
            if (!auth.currentUser || !auth.currentUser.emailVerified || !inputField || !textToTypeElement || !statusElement) {
                if(statusElement) updateElementText(statusElement, 'يرجى التحقق من بريدك للعب.', 'info'); return;
            }
            const typedText = inputField.value;
            const originalText = textToTypeElement.textContent; 
            const endTime = new Date();
            const timeTaken = (endTime - startTime) / 1000; 

            if (typedText.length < originalText.length && typedText !== originalText) {
                 updateElementText(statusElement, 'أكمل النص أولاً ثم اضغط تحقق.');
                 playSound('snd-lose');
                 return;
            }

            let errors = 0;
            for (let i = 0; i < originalText.length; i++) {
                if (i >= typedText.length || typedText[i] !== originalText[i]) {
                    errors++;
                }
            }
            if (typedText.length > originalText.length) { 
                errors += (typedText.length - originalText.length);
            }

            const words = originalText.split(/\s+/).filter(Boolean).length;
            const wpm = timeTaken > 0 ? Math.round((words / timeTaken) * 60) : 0;
            const accuracy = originalText.length > 0 ? Math.round(((originalText.length - errors) / originalText.length) * 100) : 0;
            
            updateElementText(statusElement, `الوقت: ${timeTaken.toFixed(1)} ثانية, السرعة: ${wpm} ك/د, الدقة: ${Math.max(0, accuracy)}%, الأخطاء: ${errors}`);
            playSound(accuracy >= 80 ? 'snd-win' : 'snd-lose');
            showHideElement(startButton, true);
            disableElement(inputField, true);
            disableElement(submitButton, true);
        };
        if(startButton) startButton.addEventListener('click', startGame);
        if(submitButton) submitButton.addEventListener('click', checkTyping);
        if(statusElement) updateElementText(statusElement, 'اضغط "ابدأ الاختبار"');
      };
      // --- END GAME INITIALIZATIONS ---

      // Call all game init functions
      initXOGame(); initRPSGame(); initClickTargetGame(); initReactionTestGame(); initDiceRollGame(); initMemoryGame(); initMathQuizGame(); initGuessNumberGame(); initBigSmallGame(); initTypingTestGame();

      // Initial page load logic
      showSectionByHash(); 
    });
  </script>
</body>
</html>
