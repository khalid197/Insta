<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🎮 موقع الألعاب (يتطلب تسجيل الدخول)</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; direction: rtl; background:#fafafa; color:#333; }
    nav { background:#1976d2; padding:12px; text-align:center; position:sticky; top:0; z-index: 1000;}
    nav a { color:white; margin:0 8px; text-decoration:none; font-size:1rem; }
    nav a:hover, nav a.active { text-decoration:underline; }
    nav a.disabled-link { color: #ccc; cursor: not-allowed; text-decoration: none; } /* لتعطيل الروابط */
    section { display:none; padding:20px; max-width:480px; margin:20px auto; background:white; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    section.active { display:block; }
    h2 { margin-top:0; }
    button { padding:8px 16px; margin:8px 4px; font-size:1rem; cursor:pointer; border:none; border-radius:6px; background:#0288d1; color:white; transition:background .2s; }
    button:hover { background:#026aa7; }
    button:disabled { background:#ccc; cursor:not-allowed; }
    .status, .result, .message, #auth-status { margin:15px 0; font-size:1.1rem; min-height: 1.2em; }
    .board { display:grid; grid-template-columns:repeat(3,100px); gap:8px; justify-content:center; margin:15px auto; }
    .cell { width:100px; height:100px; border:2px solid #999; display:flex; align-items:center; justify-content:center; font-size:2.5rem; background:#fdfdfd; transition:background .2s; cursor:pointer; }
    .cell:hover { background:#f0f0f0; }
    .gamebox { text-align:center; margin:15px auto; }
    .timebox { font-size:2rem; margin:15px; }
    .cards { display:grid; grid-template-columns:repeat(4,80px); gap:10px; justify-content:center; margin-bottom: 15px; }
    .card { width:80px; height:80px; background:#eee; display:flex; align-items:center; justify-content:center; font-size:1.6rem; cursor:pointer; border-radius: 4px; border: 1px solid #ccc; }
    .card.revealed { background:#fff; cursor:default; }
    .card.matched { background: #c8e6c9; }
    .input-group { margin: 10px 0; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: bold;}
    .input-group input[type="text"], .input-group input[type="number"], .input-group input[type="email"], .input-group input[type="password"] {
      padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-left: 5px; font-size: 1rem; width: calc(100% - 22px); box-sizing: border-box;
    }
    .question-area { margin-bottom:10px; font-size: 1.2rem; font-weight: bold; }
    .text-to-type { padding: 10px; border: 1px dashed #ccc; margin: 10px 0; font-size: 1.3rem; background-color: #f9f9f9; }
    #auth-status { font-weight: bold; color: #1976d2; }
    .auth-form-container { margin-bottom: 15px; }
    .auth-container button { width: calc(33.333% - 8px); }
    .hidden-by-auth { display: none !important; } /* لإخفاء العناصر التي تتطلب تسجيل دخول */
  </style>
</head>
<body>

  <nav id="main-nav">
    <a href="#login" id="nav-login-link">تسجيل الدخول</a>
    <!-- روابط الألعاب ستتم إضافتها/إزالتها بواسطة JavaScript -->
  </nav>

  <section id="login">
    <h2>تسجيل الدخول / إنشاء حساب</h2>
    <div class="auth-container">
        <div class="auth-form-container">
            <div class="input-group" id="email-group">
                <label for="login-email">البريد الإلكتروني:</label>
                <input type="email" id="login-email" required />
            </div>
            <div class="input-group" id="password-group">
                <label for="login-password">كلمة المرور (6 حروف على الأقل):</label>
                <input type="password" id="login-password" required />
            </div>
        </div>
        <button id="btn-signup">إنشاء حساب</button>
        <button id="btn-login">تسجيل الدخول</button>
        <button id="btn-logout" style="display:none;">تسجيل الخروج</button>
    </div>
    <div id="auth-status">يرجى تسجيل الدخول أو إنشاء حساب جديد.</div>
  </section>

  <!-- أقسام الألعاب ستكون مبدئيًا غير ظاهرة إذا لم يتم تسجيل الدخول -->
  <section id="xo" class="game-section hidden-by-auth">
    <h2>❌⭕ XO</h2>
    <div class="board"></div>
    <div class="status">الدور: ❌</div>
    <button id="xo-restart">إعادة XO</button>
  </section>

  <section id="rps" class="game-section hidden-by-auth">
    <h2>✊🖐✌ حجر ورقة مقص</h2>
    <div class="gamebox">
      <button data-choice="🪨">🪨</button>
      <button data-choice="📄">📄</button>
      <button data-choice="✂️">✂️</button>
    </div>
    <div class="result">اختر لبدء!</div>
  </section>

  <section id="click" class="game-section hidden-by-auth">
    <h2>🎯 اصطياد الهدف</h2>
    <div class="gamebox"><button id="click-start">ابدأ</button></div>
    <div id="click-target-area" class="gamebox"></div>
    <div class="status">اضغط "ابدأ"</div>
  </section>

  <section id="react" class="game-section hidden-by-auth">
    <h2>⌛ اختبار سرعة الضغط</h2>
    <div class="gamebox"><button id="react-start">ابدأ</button></div>
    <div class="timebox">--</div>
  </section>

  <section id="dice" class="game-section hidden-by-auth">
    <h2>🎲 لعبة النرد</h2>
    <div class="gamebox"><button id="dice-roll">رمي النرد</button></div>
    <div class="result">--</div>
  </section>

  <section id="memory" class="game-section hidden-by-auth">
    <h2>🧠 لعبة الذاكرة</h2>
    <div class="cards"></div>
    <div class="status">اضغط بطاقة للبدء</div>
    <div class="gamebox"><button id="memory-restart">إعادة اللعبة</button></div>
  </section>

  <section id="math" class="game-section hidden-by-auth">
    <h2>🧮 جمع أرقام بسرعة</h2>
    <div class="gamebox"><button id="math-start">ابدأ اللعبة</button></div>
    <div class="question-area" style="display:none;"></div>
    <div class="input-group" style="display:none;">
      <input type="number" id="math-answer" placeholder="أدخل إجابتك"/>
      <button id="math-submit">تحقق</button>
    </div>
    <div class="result">--</div>
  </section>

  <section id="guessnum" class="game-section hidden-by-auth">
    <h2>🔢 تخمين الرقم</h2>
    <div class="gamebox"><button id="guessnum-start">ابدأ اللعبة</button></div>
    <div class="input-group" style="display:none;">
      <input type="number" id="guessnum-input" placeholder="خمن بين 1 و100"/>
      <button id="guessnum-submit">خمن</button>
    </div>
    <div class="result">--</div>
    <div class="message"></div>
  </section>

  <section id="bigsmall" class="game-section hidden-by-auth">
    <h2>📏 من الأكبر؟</h2>
    <div class="gamebox"><button id="bigsmall-start">ابدأ اللعبة</button></div>
    <div class="question-area" style="display:none;"></div>
    <div class="input-group" style="display:none;">
      <input type="number" id="bigsmall-answer" placeholder="اكتب الرقم الأكبر"/>
      <button id="bigsmall-submit">تحقق</button>
    </div>
    <div class="result">--</div>
  </section>

  <section id="typing" class="game-section hidden-by-auth">
    <h2>⌨️ اختبار الكتابة</h2>
    <div class="gamebox"><button id="typing-start">ابدأ الاختبار</button></div>
    <div class="text-to-type" style="display:none;"></div>
    <div class="input-group" style="display:none;">
      <input type="text" id="typing-input" placeholder="اكتب النص هنا"/>
      <button id="typing-submit">تحقق</button>
    </div>
    <div class="status">--</div>
  </section>

  <audio id="snd-click" src="https://actions.google.com/sounds/v1/alarms/button_click.ogg"></audio>
  <audio id="snd-win" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="snd-lose" src="https://actions.google.com/sounds/v1/cartoon/cartoon_cowbell.ogg"></audio>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    // --- استبدل هذا بـ firebaseConfig الخاص بك ---
    const firebaseConfig = {
      apiKey: "AIzaSyDLzpa2HYzJZdZvY_YuviKZ6Zg0FhWTfJw",
      authDomain: "my-site-cdd00.firebaseapp.com",
      projectId: "my-site-cdd00",
      storageBucket: "my-site-cdd00.firebasestorage.app",
      messagingSenderId: "514123463555",
      appId: "1:514123463555:web:8499c5bde152537a3dd4b6",
      measurementId: "G-3Y7SYCE0NZ"
    };
    // ---------------------------------------------

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', () => {
      const playSound = (soundId) => { const sound = document.getElementById(soundId); if (sound) { sound.currentTime = 0; sound.play().catch(e => console.error("Error playing sound:", e)); } };
      const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
      const updateElementText = (element, text) => { if (element) element.textContent = text; };
      const showHideElement = (element, show, displayType = 'block') => { if (element) element.style.display = show ? displayType : 'none'; }
      const disableElement = (element, disabled) => { if(element) element.disabled = disabled; }

      const allSections = document.querySelectorAll('section'); // كل الأقسام بما فيها تسجيل الدخول
      const gameSections = document.querySelectorAll('.game-section'); // أقسام الألعاب فقط
      const mainNav = document.getElementById('main-nav');
      const navLoginLink = document.getElementById('nav-login-link');

      // بيانات روابط الألعاب
      const gameNavLinksData = [
        { href: "#xo", text: "XO" }, { href: "#rps", text: "RPS" },
        { href: "#click", text: "Target" }, { href: "#react", text: "Reaction" },
        { href: "#dice", text: "Dice" }, { href: "#memory", text: "Memory" },
        { href: "#math", text: "Math" }, { href: "#guessnum", text: "GuessNum" },
        { href: "#bigsmall", text: "BigSmall" }, { href: "#typing", text: "Typing" }
      ];
      let currentNavLinks = [navLoginLink]; // نبدأ برابط تسجيل الدخول فقط

      const updateNavigation = (isLoggedIn) => {
        // إزالة روابط الألعاب القديمة (ما عدا رابط تسجيل الدخول/الخروج)
        currentNavLinks.forEach(link => {
            if (link !== navLoginLink) link.remove();
        });
        currentNavLinks = [navLoginLink]; // إعادة التعيين

        if (isLoggedIn) {
          gameNavLinksData.forEach(data => {
            const newLink = document.createElement('a');
            newLink.href = data.href;
            newLink.textContent = data.text;
            newLink.addEventListener('click', handleNavLinkClick);
            mainNav.appendChild(newLink);
            currentNavLinks.push(newLink);
          });
        }
      };

      const showSection = (targetId, isGameSection = false) => {
        allSections.forEach(s => s.classList.remove('active')); // إخفاء كل الأقسام
        const sectionToShow = document.getElementById(targetId);
        if (sectionToShow) {
            sectionToShow.classList.add('active');
        }

        currentNavLinks.forEach(a => {
            if (a) a.classList.toggle('active', a.getAttribute('href') === `#${targetId}`);
        });
        if (isGameSection || targetId === 'login') playSound('snd-click');
      };
      
      const handleNavLinkClick = (e) => {
          e.preventDefault();
          const id = e.target.getAttribute('href').slice(1);
          const isGame = Array.from(gameSections).some(gs => gs.id === id);
          showSection(id, isGame);
      };
      navLoginLink.addEventListener('click', handleNavLinkClick);


      const loginSectionEl = document.querySelector('#login');
      const loginEmailInput = loginSectionEl.querySelector('#login-email');
      const loginPasswordInput = loginSectionEl.querySelector('#login-password');
      const btnSignup = loginSectionEl.querySelector('#btn-signup');
      const btnLogin = loginSectionEl.querySelector('#btn-login');
      const btnLogout = loginSectionEl.querySelector('#btn-logout');
      const authStatusDiv = loginSectionEl.querySelector('#auth-status');
      const emailGroup = loginSectionEl.querySelector('#email-group');
      const passwordGroup = loginSectionEl.querySelector('#password-group');
      const authFormContainer = loginSectionEl.querySelector('.auth-form-container');

      btnSignup.addEventListener('click', () => { /* ... نفس كود الإنشاء مع finally ... */
        const email = loginEmailInput.value; const password = loginPasswordInput.value;
        if (!email || !password) { updateElementText(authStatusDiv, "الرجاء إدخال البريد الإلكتروني وكلمة المرور."); return; }
        if (password.length < 6) { updateElementText(authStatusDiv, "يجب أن تكون كلمة المرور 6 حروف على الأقل."); return; }
        updateElementText(authStatusDiv, 'جاري إنشاء الحساب...'); disableElement(btnSignup, true); disableElement(btnLogin, true);
        auth.createUserWithEmailAndPassword(email, password)
          .then((userCredential) => { updateElementText(authStatusDiv, `تم إنشاء الحساب بنجاح! مرحباً ${userCredential.user.email}`); loginEmailInput.value = ''; loginPasswordInput.value = ''; })
          .catch((error) => { updateElementText(authStatusDiv, `خطأ في إنشاء الحساب: ${error.message}`); })
          .finally(() => { disableElement(btnSignup, false); disableElement(btnLogin, false); });
      });

      btnLogin.addEventListener('click', () => { /* ... نفس كود تسجيل الدخول مع finally ... */
        const email = loginEmailInput.value; const password = loginPasswordInput.value;
        if (!email || !password) { updateElementText(authStatusDiv, "الرجاء إدخال البريد الإلكتروني وكلمة المرور."); return; }
        updateElementText(authStatusDiv, 'جاري تسجيل الدخول...'); disableElement(btnSignup, true); disableElement(btnLogin, true);
        auth.signInWithEmailAndPassword(email, password)
          .then((userCredential) => { updateElementText(authStatusDiv, `تم تسجيل الدخول بنجاح! مرحباً ${userCredential.user.email}`); })
          .catch((error) => { updateElementText(authStatusDiv, `خطأ في تسجيل الدخول: ${error.message}`); })
          .finally(() => { disableElement(btnSignup, false); disableElement(btnLogin, false); });
      });

      btnLogout.addEventListener('click', () => { auth.signOut().catch((error) => { updateElementText(authStatusDiv, `خطأ في تسجيل الخروج: ${error.message}`); }); });

      auth.onAuthStateChanged(user => {
        if (user) {
          updateElementText(authStatusDiv, `أهلاً بك, ${user.email}`);
          updateElementText(navLoginLink, 'تسجيل الخروج');
          navLoginLink.onclick = (e) => { e.preventDefault(); btnLogout.click(); }; // Note: showSection('login') will be handled by state change
          showHideElement(btnLogout, true, 'inline-block');
          showHideElement(authFormContainer, false); // إخفاء فورم الإيميل والباسورد
          showHideElement(btnLogin, false);
          showHideElement(btnSignup, false);
          gameSections.forEach(gs => gs.classList.remove('hidden-by-auth'));
          updateNavigation(true);
          // إذا لم يكن هناك قسم فعال أو القسم الفعال هو تسجيل الدخول، اعرض أول لعبة
          const activeSection = document.querySelector('section.active');
          if (!activeSection || activeSection.id === 'login') {
            if (gameNavLinksData.length > 0) {
              showSection(gameNavLinksData[0].href.slice(1), true);
            }
          }
        } else {
          updateElementText(authStatusDiv, 'أنت غير مسجل الدخول. قم بتسجيل الدخول أو إنشاء حساب جديد.');
          updateElementText(navLoginLink, 'تسجيل الدخول');
          navLoginLink.onclick = handleNavLinkClick; // إعادة المعالج الأصلي
          showHideElement(btnLogout, false);
          showHideElement(authFormContainer, true);
          showHideElement(btnLogin, true, 'inline-block');
          showHideElement(btnSignup, true, 'inline-block');
          gameSections.forEach(gs => {
            gs.classList.add('hidden-by-auth');
            gs.classList.remove('active'); // تأكد من إخفاء أي لعبة كانت نشطة
          });
          updateNavigation(false);
          showSection('login', false); // عرض قسم تسجيل الدخول دائمًا عند عدم تسجيل الدخول
          loginEmailInput.value = ''; loginPasswordInput.value = '';
        }
      });

      // دوال تهيئة الألعاب (يجب أن تكون موجودة)
      const initXOGame = () => { /* ... كود لعبة XO ... */ };
      const initRPSGame = () => { /* ... كود لعبة RPS ... */ };
      const initClickTargetGame = () => { /* ... كود لعبة Click Target ... */ };
      const initReactionTestGame = () => { /* ... كود لعبة Reaction Test ... */ };
      const initDiceGame = () => { /* ... كود لعبة Dice ... */ };
      const initMemoryGame = () => { /* ... كود لعبة Memory ... */ };
      const initMathGame = () => { /* ... كود لعبة Math ... */ };
      const initGuessNumGame = () => { /* ... كود لعبة GuessNum ... */ };
      const initBigSmallGame = () => { /* ... كود لعبة BigSmall ... */ };
      const initTypingTestGame = () => { /* ... كود لعبة Typing ... */ };

      // استدعاء دوال التهيئة
      initXOGame(); initRPSGame(); initClickTargetGame(); initReactionTestGame(); initDiceGame(); initMemoryGame(); initMathGame(); initGuessNumGame(); initBigSmallGame(); initTypingTestGame();

      // لا تقم بتعيين قسم نشط مبدئيًا هنا، onAuthStateChanged سيتولى الأمر
    });
  </script>
</body>
</html>
